import { Callout } from 'nextra/components';
import { NextSeo } from 'next-seo';
import { Tab, Tabs } from 'nextra/components';
import cloudDbCreate from './database/cloud-db-create.png';
import cloudVpc from './database/cloud-vpc.png';
import banner7777 from './database/7777.png';
import Image from 'next/image';

<NextSeo description="Configure Bref to use a database in your PHP application on AWS Lambda." />

# Using a database

AWS offers the [RDS](https://aws.amazon.com/rds/) service to run MySQL and PostgreSQL databases.

Here are some of the database services offered by RDS:

- MySQL
- PostgreSQL
- [Aurora MySQL/PostgreSQL](https://aws.amazon.com/rds/aurora/): closed-source database compatible with MySQL or PostgreSQL
- [Aurora Serverless v2 MySQL/PostgreSQL](https://aws.amazon.com/rds/aurora/serverless/): similar to Aurora but scales automatically on-demand

<Callout>
    Aurora Serverless can be configured to scale down to 0 when unused (which costs $0), however be careful with this option: the database can take up to 15 seconds to un-pause.
</Callout>

## Internet-accessible vs VPC databases

| | Internet-accessible | VPC (private network) |
|---|---|---|
| Security | Password only | Network-isolated + password |
| Best for | Non-critical projects | Projects requiring strong isolation |
| Complexity | Simple | Requires VPC + NAT Gateway |
| Extra cost | None | ~$32/month for NAT Gateway |
| Access from your machine | Direct connection | Via SSH tunnel ([7777](https://port7777.com)) |

Start with an internet-accessible database to get going quickly, then switch to a VPC database when you need stronger isolation.

## Internet-accessible databases

<Tabs items={['Bref Cloud', 'AWS console']}>
    <Tab>
        In the Bref Cloud dashboard, open the "Databases" page and [click "Create database"](https://bref.cloud/databases/create).

        Fill in the form and click "Create":

        <Image className="mt-3" src={cloudDbCreate} alt="Bref Cloud create database form" />

        The `serverless.yml` configuration with credentials [securely stored in AWS SSM](./variables.mdx) will be displayed once the database is created.
    </Tab>
    <Tab>
        In the [RDS console](https://console.aws.amazon.com/rds/home):

        - switch to the region of your application
        - click "Create database"
        - select the type of database you want to create (engine, instance class, etc.) and fill the rest of the form
        - make sure to select "Public access: Yes"

        Once the database is created, make sure the security group allows inbound connections on the database port from any IP address (AWS Lambda IPs are dynamic).

        Copy the endpoint (hostname) and configure your PHP application to connect to it. Don't forget to [securely store the username and password in AWS SSM](./variables.mdx).

        Tips to better control costs:

        - for non-critical databases you can disable replication
        - switch storage to "General Purpose (SSD)" for lower costs
        - you can disable "enhanced monitoring" to avoid the associated costs
    </Tab>
</Tabs>

## VPC databases (private network)

<Tabs items={['Bref Cloud', 'AWS console']}>
    <Tab>
        Bref Cloud handles VPC creation, subnets, security groups, and NAT Gateway configuration for you.

        **1. Create a network** in the Bref Cloud dashboard:

        <Image className="mt-3" src={cloudVpc} alt="Bref Cloud create network" style={{maxWidth: 500}} />

        The network includes a VPC, subnets, security groups, and a NAT Gateway (~$33/month, shown in the dashboard). A single network can be reused across multiple applications and databases.

        **2. Create a database** and select the network you created.

        **3. Deploy** â€” Bref Cloud automatically adds the VPC configuration to your deployment. No changes to `serverless.yml` are needed.
    </Tab>
    <Tab>
        <Callout type="warning">
            Lambda functions in a VPC **lose internet access**. This can cause timeouts. You need a NAT Gateway to restore internet access (~$32/month). Alternatively, you can use [a NAT instance](https://fck-nat.dev/) (from $3/month).
        </Callout>

        You can follow [this tutorial](https://medium.com/@philippholly/aws-lambda-enable-outgoing-internet-access-within-vpc-8dd250e11e12) to set up a NAT Gateway, use [the serverless VPC plugin](https://github.com/smoketurner/serverless-vpc-plugin), or use the complete example in [Serverless Visually Explained](https://serverless-visually-explained.com/).

        You can use one VPC and one NAT Gateway for multiple projects. To avoid the NAT Gateway cost, you can also access AWS services via [private VPC endpoints](https://docs.aws.amazon.com/en_pv/vpc/latest/userguide/vpc-endpoints-access.html).

        ### Creating a database

        In the [RDS console](https://console.aws.amazon.com/rds/home):

        - click "Create database"
        - select the type of database you want to create and fill in the form
        - for a simpler configuration leave the default VPC in the last step

        Tips to better control costs:

        - for non-critical databases you can disable replication
        - switch storage to "General Purpose (SSD)" for lower costs
        - you can disable "enhanced monitoring" to avoid the associated costs

        ### Connecting Lambda to the VPC

        To retrieve the information needed to let AWS Lambda access the database, go into [the RDS dashboard](https://console.aws.amazon.com/rds/home#databases:) and open the database you created.

        <Callout>
            It may take a few minutes for the database to be created.
        </Callout>

        Find:

        - The **endpoint** (hostname of the database, available after creation completes).
        - The **security group ID** (in the "VPC security groups" section), e.g. `sg-03f68e1100481622b`.
        - The list of **subnets**, e.g. `subnet-12f4130e` (there are several, one per availability zone).

        Add the VPC configuration to `serverless.yml` ([documentation](https://github.com/oss-serverless/serverless/blob/main/docs/guides/functions.md#vpc-configuration)):

        ```yml filename="serverless.yml"
        functions:
            hello:
                # ...
                vpc:
                    securityGroupIds:
                        - sg-03f68e1100481622b
                    subnetIds:
                        - subnet-12f4130e
                        - subnet-c5fe33e5
                        - subnet-11aa85dc
                        - subnet-85dcf240
        ```

        ### Authorizing Lambda connections

        You need to allow Lambda to connect to the database's security group:

        - open the database in RDS and click the security group
        - in the "Inbound" tab click "Edit"
        - add a rule: select MySQL/Aurora (or PostgreSQL) and set a "custom" source: select the security group itself (type `sg-` and use the autocompletion)
        - save
    </Tab>
</Tabs>

You can learn more from the AWS documentation about [configuring a Lambda to access resources in a VPC](https://docs.aws.amazon.com/lambda/latest/dg/vpc.html).

## Connecting from PHP

[Bref Cloud](https://bref.sh/cloud) automatically creates SSM parameters for your database credentials and configures the environment variables. If you are using the Serverless Framework, store credentials securely using SSM parameters ([read more](./variables.mdx#secrets)).

<Tabs items={['Laravel', 'Symfony', 'PHP']}>
    <Tab>
        ```yml filename="serverless.yml"
        provider:
            environment:
                DB_HOST: <endpoint>
                DB_DATABASE: my_database
                DB_USERNAME: ${ssm:/my-app/db-username}
                DB_PASSWORD: ${ssm:/my-app/db-password}
        ```

        Laravel reads these environment variables automatically to configure the database connection.
    </Tab>
    <Tab>
        ```yml filename="serverless.yml"
        provider:
            environment:
                DATABASE_URL: mysql://${ssm:/my-app/db-username}:${ssm:/my-app/db-password}@<endpoint>/my_database
        ```

        Doctrine is auto-configured by Symfony using the `DATABASE_URL` environment variable.
    </Tab>
    <Tab>
        Connect to the database using the endpoint, for example with PDO:

        ```
        mysql://user:password@dbname.e2sctvp0nqos.us-east-1.rds.amazonaws.com/dbname
        ```
    </Tab>
</Tabs>

Also refer to the [Extensions](/docs/environment/php.mdx#extensions) section to see if you need to enable any database-specific extensions.

## Running database migrations

<Tabs items={['Laravel', 'Symfony', 'PHP']}>
    <Tab>
        <Tabs items={['Bref Cloud', 'Serverless Framework']}>
            <Tab>
                ```bash
                bref command "migrate --force"
                ```
            </Tab>
            <Tab>
                ```bash
                serverless bref:cli --args="migrate --force"
                ```
            </Tab>
        </Tabs>
    </Tab>
    <Tab>
        <Tabs items={['Bref Cloud', 'Serverless Framework']}>
            <Tab>
                ```bash
                bref command "doctrine:migrations:migrate --no-interaction"
                ```
            </Tab>
            <Tab>
                ```bash
                serverless bref:cli --args="doctrine:migrations:migrate --no-interaction"
                ```
            </Tab>
        </Tabs>
    </Tab>
    <Tab>
        You can run any CLI script via the console runtime. Read the [Console runtime documentation](../runtimes/console.mdx) to learn more.
    </Tab>
</Tabs>

<Callout>
    A console function must be defined in your `serverless.yml`. Check the [getting started guides](/docs/getting-started) for examples.
</Callout>

## Accessing the database from your machine

A private database in a VPC cannot be accessed from the internet directly. To connect from your machine (e.g. with TablePlus or DBeaver), use an SSH tunnel.

To create an SSH tunnel easily and securely, **[check out 7777](https://port7777.com/?utm_source=bref)**, made by Bref maintainers:

<a href="https://port7777.com/?utm_source=bref"><Image src={banner7777} alt="7777 - SSH tunnels to your database" style={{maxWidth: 500}} /></a>

To expose the database publicly on the internet instead, [follow this guide](database-public.md).
